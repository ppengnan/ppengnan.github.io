<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¹è¿›ç‰ˆçœ¼åŠ¨è¿½è¸ª - Nan Peng</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      overflow-x: hidden;
      background: #f9f9f9;
    }

    /* Top Control Bar */
    .control-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 10000;
    }

    .control-bar-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .control-bar-right {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn:hover {
      background: #f5f5f5;
      border-color: #999;
    }

    .btn-primary {
      background: #477dfc;
      color: white;
      border-color: #477dfc;
    }

    .btn-primary:hover {
      background: #3a6ad9;
    }

    /* Webcam Preview */
    .webcam-preview {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 240px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 9999;
      overflow: hidden;
    }

    .webcam-header {
      background: #333;
      color: white;
      padding: 8px 12px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .webcam-video {
      width: 100%;
      height: 180px;
      background: #000;
      display: block;
      transform: scaleX(-1);
    }

    .webcam-info {
      padding: 8px 12px;
      font-size: 11px;
      color: #666;
      background: #f5f5f5;
    }

    /* Eye Cursor */
    .eye-cursor {
      position: fixed;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,0,0,0.7) 0%, rgba(255,0,0,0.3) 70%, transparent 100%);
      border: 2px solid white;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      pointer-events: none;
      z-index: 9998;
      transition: none;
      display: none;
    }

    .eye-cursor.active {
      display: block;
    }

    /* Calibration Debug Point */
    .debug-point {
      position: fixed;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(0,255,0,0.5);
      pointer-events: none;
      z-index: 9997;
    }

    /* Calibration Screen */
    .calibration-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 10002;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .calibration-screen.hidden {
      display: none;
    }

    .calibration-instruction {
      font-size: 28px;
      margin-bottom: 20px;
      color: white;
      text-align: center;
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .calibration-subtitle {
      font-size: 16px;
      margin-bottom: 40px;
      color: rgba(255,255,255,0.9);
      text-align: center;
    }

    .calibration-grid {
      position: relative;
      width: 90vw;
      height: 70vh;
      max-width: 1200px;
    }

    .calibration-point {
      position: absolute;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }

    .calibration-point.active {
      width: 80px;
      height: 80px;
      background: #ff6b6b;
      color: white;
      animation: pulse 1.5s infinite;
    }

    .calibration-point.completed {
      background: #51cf66;
      color: white;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% {
        transform: translate(-50%, -50%) scale(1);
        box-shadow: 0 0 0 0 rgba(255,107,107,0.7);
      }
      50% {
        transform: translate(-50%, -50%) scale(1.1);
        box-shadow: 0 0 0 30px rgba(255,107,107,0);
      }
    }

    .calibration-progress {
      margin-top: 40px;
      font-size: 20px;
      color: white;
      background: rgba(255,255,255,0.2);
      padding: 15px 30px;
      border-radius: 30px;
      backdrop-filter: blur(10px);
    }

    .calibration-timer {
      font-size: 48px;
      color: white;
      font-weight: bold;
      margin-top: 20px;
    }

    /* Content Area */
    .content-wrapper {
      margin-top: 60px;
      padding: 40px 20px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
      background: white;
      min-height: calc(100vh - 60px);
      font-size: 18px;
      line-height: 1.8;
    }

    .content-wrapper h1 {
      margin-bottom: 20px;
      color: #333;
    }

    .content-wrapper p {
      margin-bottom: 15px;
      color: #555;
    }

    .test-links {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 30px 0;
    }

    .test-link {
      padding: 15px 25px;
      background: #477dfc;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s;
      font-weight: 500;
    }

    .test-link:hover {
      background: #3a6ad9;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(71,125,252,0.3);
    }

    .test-link.eye-hovering {
      box-shadow: 0 0 0 4px rgba(255,215,0,0.6);
      background-color: #ffd700;
      color: #333;
    }

    /* Status Bar */
    .status-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 45px;
      background: #2c3e50;
      color: white;
      display: flex;
      align-items: center;
      padding: 0 20px;
      font-size: 13px;
      gap: 25px;
      z-index: 9996;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #51cf66;
    }

    .status-indicator.error {
      background: #ff6b6b;
    }

    .status-indicator.warning {
      background: #ffd43b;
    }

    /* Message Toast */
    .message-toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 20px 40px;
      border-radius: 12px;
      font-size: 18px;
      z-index: 10004;
      display: none;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }

    .message-toast.visible {
      display: block;
      animation: fadeInOut 2.5s;
    }

    @keyframes fadeInOut {
      0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      10%, 90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    /* Accuracy Display */
    .accuracy-display {
      position: fixed;
      top: 80px;
      left: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 9999;
      font-size: 13px;
    }

    .accuracy-item {
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }

    .accuracy-label {
      color: #666;
    }

    .accuracy-value {
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>
  <!-- Calibration Screen -->
  <div class="calibration-screen" id="calibrationScreen">
    <div class="calibration-instruction">ğŸ“ çœ¼åŠ¨è¿½è¸ªæ ¡å‡†</div>
    <div class="calibration-subtitle">è¯·ç”¨çœ¼ç›ç›¯ç€æ¯ä¸ªçº¢è‰²åœ†ç‚¹3ç§’é’Ÿï¼ˆä¸è¦ç§»åŠ¨é¼ æ ‡ï¼Œåªç”¨çœ¼ç›çœ‹ï¼‰</div>
    <div class="calibration-grid" id="calibrationGrid"></div>
    <div class="calibration-progress" id="calibrationProgress">è¿›åº¦: 0/9 å®Œæˆ</div>
    <div class="calibration-timer" id="calibrationTimer"></div>
  </div>

  <!-- Top Control Bar -->
  <div class="control-bar">
    <div class="control-bar-left">
      <span style="font-weight: 600; color: #333;">æ”¹è¿›ç‰ˆçœ¼åŠ¨è¿½è¸ªç³»ç»Ÿ</span>
    </div>
    <div class="control-bar-right">
      <button class="btn" onclick="recalibrate()">ğŸ”„ é‡æ–°æ ¡å‡†</button>
      <button class="btn" onclick="toggleDebug()">ğŸ› è°ƒè¯•æ¨¡å¼</button>
    </div>
  </div>

  <!-- Webcam Preview -->
  <div class="webcam-preview" id="webcamPreview">
    <div class="webcam-header">
      <span>ğŸ“¹ æ‘„åƒå¤´è§†å›¾</span>
    </div>
    <video class="webcam-video" id="webcamVideo" autoplay playsinline></video>
    <div class="webcam-info" id="webcamInfo">
      æ­£åœ¨åˆå§‹åŒ–...
    </div>
  </div>

  <!-- Accuracy Display -->
  <div class="accuracy-display" id="accuracyDisplay">
    <div class="accuracy-item">
      <span class="accuracy-label">Xè½´åå·®:</span>
      <span class="accuracy-value" id="errorX">-- px</span>
    </div>
    <div class="accuracy-item">
      <span class="accuracy-label">Yè½´åå·®:</span>
      <span class="accuracy-value" id="errorY">-- px</span>
    </div>
    <div class="accuracy-item">
      <span class="accuracy-label">æ€»ä½“ç²¾åº¦:</span>
      <span class="accuracy-value" id="accuracy">--</span>
    </div>
    <div class="accuracy-item">
      <span class="accuracy-label">æ•°æ®ç‚¹æ•°:</span>
      <span class="accuracy-value" id="dataPoints">0</span>
    </div>
  </div>

  <!-- Eye Cursor -->
  <div class="eye-cursor" id="eyeCursor"></div>

  <!-- Content Wrapper -->
  <div class="content-wrapper" id="contentWrapper">
    <h1>çœ¼åŠ¨è¿½è¸ªæµ‹è¯•é¡µé¢</h1>
    <p>è¿™æ˜¯ä¸€ä¸ªæ”¹è¿›ç‰ˆçš„çœ¼åŠ¨è¿½è¸ªç³»ç»Ÿã€‚å®Œæˆæ ¡å‡†åï¼Œä½ çš„çœ¼ç›æ³¨è§†ä½ç½®ä¼šæ˜¾ç¤ºä¸ºçº¢è‰²å…‰æ ‡ã€‚</p>
    
    <h2>æµ‹è¯•é“¾æ¥ï¼š</h2>
    <div class="test-links">
      <a href="#" class="test-link">é“¾æ¥ 1</a>
      <a href="#" class="test-link">é“¾æ¥ 2</a>
      <a href="#" class="test-link">é“¾æ¥ 3</a>
      <a href="#" class="test-link">é“¾æ¥ 4</a>
      <a href="#" class="test-link">é“¾æ¥ 5</a>
      <a href="#" class="test-link">é“¾æ¥ 6</a>
    </div>

    <p>å°è¯•ç”¨çœ¼ç›çœ‹å‘ä¸åŒçš„é“¾æ¥ï¼Œå®ƒä»¬ä¼šé«˜äº®æ˜¾ç¤ºã€‚ç³»ç»Ÿä¼šå®æ—¶æ˜¾ç¤ºçœ¼åŠ¨è¿½è¸ªçš„ç²¾åº¦ä¿¡æ¯ã€‚</p>
    
    <h2>ä½¿ç”¨è¯´æ˜ï¼š</h2>
    <ul style="line-height: 2;">
      <li>ç¡®ä¿ä½ çš„è„¸éƒ¨æ­£å¯¹æ‘„åƒå¤´ï¼Œè·ç¦»çº¦50-70cm</li>
      <li>ä¿æŒå¤´éƒ¨ç›¸å¯¹é™æ­¢ï¼Œåªç§»åŠ¨çœ¼ç›</li>
      <li>å…‰çº¿å……è¶³ï¼Œé¿å…èƒŒå…‰</li>
      <li>æ ¡å‡†æ—¶è¦çœŸæ­£"ç›¯ç€"çº¢ç‚¹çœ‹ï¼Œä¸è¦å¿«é€Ÿç§»åŠ¨çœ¼ç›</li>
      <li>å¦‚æœç²¾åº¦ä¸ä½³ï¼Œç‚¹å‡»"é‡æ–°æ ¡å‡†"æŒ‰é’®</li>
    </ul>

    <p style="margin-top: 40px; padding-top: 40px; border-top: 1px solid #eee;">
      Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. 
      Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
    </p>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <div class="status-item">
      <span class="status-indicator" id="trackingIndicator"></span>
      <span>è¿½è¸ª: <span id="trackingStatus">åˆå§‹åŒ–ä¸­</span></span>
    </div>
    <div class="status-item">
      <span class="status-indicator" id="cameraIndicator"></span>
      <span>æ‘„åƒå¤´: <span id="cameraStatus">ç­‰å¾…æˆæƒ</span></span>
    </div>
    <div class="status-item">
      <span>âš¡ <span id="fpsDisplay">0</span> FPS</span>
    </div>
    <div class="status-item">
      <span>ğŸ“Š æ ·æœ¬æ•°: <span id="sampleCount">0</span></span>
    </div>
  </div>

  <!-- Message Toast -->
  <div class="message-toast" id="messageToast"></div>

  <!-- WebGazer.js -->
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>

  <script>
    // Global State
    let isCalibrated = false;
    let gazeData = { x: 0, y: 0 };
    let hoveredElement = null;
    let debugMode = false;
    let calibrationData = [];
    let sampleCount = 0;

    // Smoothing parameters
    let gazeHistory = [];
    const HISTORY_SIZE = 10;
    const OUTLIER_THRESHOLD = 200; // ç§»é™¤è¶…è¿‡200pxçš„å¼‚å¸¸å€¼

    // Initialize
    window.addEventListener('load', () => {
      startCalibration();
    });

    // Start Calibration
    function startCalibration() {
      navigator.mediaDevices.getUserMedia({ 
        video: { 
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      })
        .then(stream => {
          const video = document.getElementById('webcamVideo');
          video.srcObject = stream;
          updateCameraStatus('å·²è¿æ¥', false);
          initWebGazer();
          setTimeout(() => setupCalibrationPoints(), 1000);
        })
        .catch(err => {
          showMessage('âŒ æ‘„åƒå¤´è®¿é—®è¢«æ‹’ç»ï¼Œè¯·å…è®¸æ‘„åƒå¤´æƒé™');
          updateCameraStatus('æƒé™è¢«æ‹’ç»', true);
        });
    }

    // Initialize WebGazer
    function initWebGazer() {
      webgazer.setGazeListener((data, timestamp) => {
        if (data && isCalibrated) {
          sampleCount++;
          const smoothedGaze = smoothGazeData(data.x, data.y);
          gazeData = smoothedGaze;
          updateEyeCursor(smoothedGaze.x, smoothedGaze.y);
          checkHoveredElement(smoothedGaze.x, smoothedGaze.y);
          
          if (debugMode) {
            createDebugPoint(data.x, data.y);
          }
        }
      }).begin();

      webgazer.showVideoPreview(false);
      webgazer.showPredictionPoints(false);
      
      // å…³é”®ï¼šä½¿ç”¨å²­å›å½’ï¼Œç²¾åº¦æ›´é«˜
      webgazer.setRegression('ridge');
      
      // å¯ç”¨Kalmanæ»¤æ³¢
      webgazer.applyKalmanFilter(true);
      
      // è®¾ç½®æ›´æ–°é¢‘ç‡
      webgazer.params.showVideo = false;
      webgazer.params.showFaceOverlay = false;
      webgazer.params.showFaceFeedbackBox = false;
      
      updateWebcamInfo('WebGazerå·²åˆå§‹åŒ–');
      updateTrackingStatus('å‡†å¤‡å°±ç»ª', false);
    }

    // Smooth Gaze Data - æ”¹è¿›çš„å¹³æ»‘ç®—æ³•
    function smoothGazeData(x, y) {
      // æ£€æµ‹å¹¶ç§»é™¤å¼‚å¸¸å€¼
      if (gazeHistory.length > 0) {
        const lastGaze = gazeHistory[gazeHistory.length - 1];
        const distance = Math.sqrt(
          Math.pow(x - lastGaze.x, 2) + 
          Math.pow(y - lastGaze.y, 2)
        );
        
        // å¦‚æœç§»åŠ¨è·ç¦»å¤ªå¤§ï¼Œè®¤ä¸ºæ˜¯å¼‚å¸¸å€¼
        if (distance > OUTLIER_THRESHOLD) {
          return lastGaze; // ä½¿ç”¨ä¸Šä¸€ä¸ªå€¼
        }
      }

      gazeHistory.push({ x, y });
      if (gazeHistory.length > HISTORY_SIZE) {
        gazeHistory.shift();
      }

      // åŠ æƒå¹³å‡ï¼šæœ€è¿‘çš„æ•°æ®æƒé‡æ›´é«˜
      let weightedX = 0, weightedY = 0, totalWeight = 0;
      for (let i = 0; i < gazeHistory.length; i++) {
        const weight = i + 1; // çº¿æ€§æƒé‡
        weightedX += gazeHistory[i].x * weight;
        weightedY += gazeHistory[i].y * weight;
        totalWeight += weight;
      }

      return {
        x: weightedX / totalWeight,
        y: weightedY / totalWeight
      };
    }

    // Setup Calibration Points - 9ä¸ªç‚¹è¦†ç›–æ•´ä¸ªå±å¹•
    function setupCalibrationPoints() {
      const grid = document.getElementById('calibrationGrid');
      grid.innerHTML = '';
      
      // 3x3ç½‘æ ¼ï¼Œè¦†ç›–å±å¹•çš„æ›´å¤šåŒºåŸŸ
      const positions = [
        { x: '10%', y: '10%' },   // å·¦ä¸Š
        { x: '50%', y: '10%' },   // ä¸­ä¸Š
        { x: '90%', y: '10%' },   // å³ä¸Š
        { x: '10%', y: '50%' },   // å·¦ä¸­
        { x: '50%', y: '50%' },   // ä¸­ä¸­
        { x: '90%', y: '50%' },   // å³ä¸­
        { x: '10%', y: '90%' },   // å·¦ä¸‹
        { x: '50%', y: '90%' },   // ä¸­ä¸‹
        { x: '90%', y: '90%' }    // å³ä¸‹
      ];

      let currentPoint = 0;
      let gazingStartTime = 0;
      let gazingInterval = null;

      positions.forEach((pos, index) => {
        const point = document.createElement('div');
        point.className = 'calibration-point';
        point.style.left = pos.x;
        point.style.top = pos.y;
        point.style.transform = 'translate(-50%, -50%)';
        point.textContent = index + 1;
        point.id = `point-${index}`;
        
        // é¼ æ ‡æ‚¬åœå¼€å§‹æ ¡å‡†
        point.addEventListener('mouseenter', () => {
          if (index === currentPoint) {
            gazingStartTime = Date.now();
            const timerDisplay = document.getElementById('calibrationTimer');
            
            gazingInterval = setInterval(() => {
              const elapsed = Date.now() - gazingStartTime;
              const remaining = Math.max(0, 3 - Math.floor(elapsed / 1000));
              timerDisplay.textContent = remaining > 0 ? `${remaining}ç§’` : 'âœ“';
              
              if (elapsed >= 3000) {
                clearInterval(gazingInterval);
                completeCalibrationPoint(point, index);
                currentPoint++;
                
                document.getElementById('calibrationProgress').textContent = 
                  `è¿›åº¦: ${currentPoint}/9 å®Œæˆ`;
                
                if (currentPoint < 9) {
                  document.getElementById(`point-${currentPoint}`).classList.add('active');
                } else {
                  completeCalibration();
                }
              }
            }, 100);
          }
        });
        
        point.addEventListener('mouseleave', () => {
          if (gazingInterval) {
            clearInterval(gazingInterval);
            document.getElementById('calibrationTimer').textContent = '';
          }
        });
        
        grid.appendChild(point);
      });

      document.getElementById('point-0').classList.add('active');
      showMessage('ğŸ‘€ è¯·å°†é¼ æ ‡ç§»åŠ¨åˆ°çº¢è‰²åœ†ç‚¹ä¸Šæ–¹å¹¶ç”¨çœ¼ç›ç›¯ç€çœ‹3ç§’');
    }

    // Complete Calibration Point
    function completeCalibrationPoint(point, index) {
      point.classList.remove('active');
      point.classList.add('completed');
      
      // å­˜å‚¨æ ¡å‡†æ•°æ®ç”¨äºç²¾åº¦è¯„ä¼°
      const rect = point.getBoundingClientRect();
      calibrationData.push({
        index,
        x: rect.left + rect.width / 2,
        y: rect.top + rect.height / 2
      });
      
      showMessage(`âœ“ ç‚¹ ${index + 1} æ ¡å‡†å®Œæˆ`);
    }

    // Complete Calibration
    function completeCalibration() {
      isCalibrated = true;
      gazeHistory = [];
      
      showMessage('âœ… æ ¡å‡†å®Œæˆï¼æ­£åœ¨è¯„ä¼°ç²¾åº¦...');
      updateTrackingStatus('å·²æ ¡å‡†', false);
      
      setTimeout(() => {
        document.getElementById('calibrationScreen').classList.add('hidden');
        document.getElementById('eyeCursor').classList.add('active');
        
        // å¼€å§‹ç²¾åº¦è¯„ä¼°
        setTimeout(() => evaluateAccuracy(), 2000);
      }, 1500);
    }

    // Evaluate Accuracy
    function evaluateAccuracy() {
      let totalErrorX = 0, totalErrorY = 0;
      let measurements = 0;
      
      const evaluationInterval = setInterval(() => {
        if (measurements >= 30) {
          clearInterval(evaluationInterval);
          
          const avgErrorX = Math.round(totalErrorX / measurements);
          const avgErrorY = Math.round(totalErrorY / measurements);
          const totalError = Math.round(Math.sqrt(avgErrorX**2 + avgErrorY**2));
          
          document.getElementById('errorX').textContent = avgErrorX + ' px';
          document.getElementById('errorY').textContent = avgErrorY + ' px';
          
          let accuracyRating = 'ä¼˜ç§€';
          if (totalError > 100) accuracyRating = 'è¾ƒå·®';
          else if (totalError > 60) accuracyRating = 'ä¸€èˆ¬';
          else if (totalError > 30) accuracyRating = 'è‰¯å¥½';
          
          document.getElementById('accuracy').textContent = accuracyRating + ` (${totalError}px)`;
          
          if (totalError > 100) {
            showMessage('âš ï¸ ç²¾åº¦è¾ƒä½ï¼Œå»ºè®®é‡æ–°æ ¡å‡†');
          }
          
          return;
        }
        
        // éšæœºé€‰æ‹©ä¸€ä¸ªæ ¡å‡†ç‚¹è¿›è¡Œæ¯”è¾ƒ
        const testPoint = calibrationData[Math.floor(Math.random() * calibrationData.length)];
        const errorX = Math.abs(gazeData.x - testPoint.x);
        const errorY = Math.abs(gazeData.y - testPoint.y);
        
        totalErrorX += errorX;
        totalErrorY += errorY;
        measurements++;
      }, 200);
    }

    // Update Eye Cursor
    function updateEyeCursor(x, y) {
      const cursor = document.getElementById('eyeCursor');
      cursor.style.left = (x - 10) + 'px';
      cursor.style.top = (y - 10) + 'px';
    }

    // Check Hovered Element
    function checkHoveredElement(x, y) {
      const element = document.elementFromPoint(x, y);
      
      if (element && (element.tagName === 'A' || element.tagName === 'BUTTON')) {
        if (hoveredElement !== element) {
          if (hoveredElement) hoveredElement.classList.remove('eye-hovering');
          element.classList.add('eye-hovering');
          hoveredElement = element;
        }
      } else {
        if (hoveredElement) {
          hoveredElement.classList.remove('eye-hovering');
          hoveredElement = null;
        }
      }
    }

    // Create Debug Point
    function createDebugPoint(x, y) {
      const point = document.createElement('div');
      point.className = 'debug-point';
      point.style.left = x + 'px';
      point.style.top = y + 'px';
      document.body.appendChild(point);
      
      setTimeout(() => point.remove(), 500);
    }

    // Show Message
    function showMessage(text) {
      const toast = document.getElementById('messageToast');
      toast.textContent = text;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 2500);
    }

    // Recalibrate
    function recalibrate() {
      isCalibrated = false;
      gazeHistory = [];
      calibrationData = [];
      sampleCount = 0;
      
      document.getElementById('calibrationScreen').classList.remove('hidden');
      document.getElementById('eyeCursor').classList.remove('active');
      
      setTimeout(() => setupCalibrationPoints(), 500);
    }

    // Toggle Debug Mode
    function toggleDebug() {
      debugMode = !debugMode;
      showMessage(debugMode ? 'ğŸ› è°ƒè¯•æ¨¡å¼å·²å¼€å¯' : 'âœ“ è°ƒè¯•æ¨¡å¼å·²å…³é—­');
    }

    // Update Status Functions
    function updateCameraStatus(text, isError) {
      document.getElementById('cameraStatus').textContent = text;
      const indicator = document.getElementById('cameraIndicator');
      indicator.className = 'status-indicator' + (isError ? ' error' : '');
    }

    function updateTrackingStatus(text, isError) {
      document.getElementById('trackingStatus').textContent = text;
      const indicator = document.getElementById('trackingIndicator');
      indicator.className = 'status-indicator' + (isError ? ' error' : '');
    }

    function updateWebcamInfo(text) {
      document.getElementById('webcamInfo').text
