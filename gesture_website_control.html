<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ‘‹ Gesture Control Mode</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      margin: 0; 
      overflow: hidden; 
      font-family: Arial, sans-serif;
    }
    
    #video-container {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 320px;
      height: 240px;
      border: 3px solid #00ff00;
      border-radius: 10px;
      overflow: hidden;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    #input_video, #output_canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    #website-frame {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    
    #cursor {
      position: fixed;
      width: 30px;
      height: 30px;
      border: 3px solid #ff0000;
      border-radius: 50%;
      pointer-events: none;
      z-index: 999;
      display: none;
      transition: transform 0.1s;
    }
    
    #cursor.clicking {
      background: rgba(255, 0, 0, 0.3);
      transform: scale(1.5);
    }
    
    #info-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      z-index: 1000;
      font-size: 14px;
      max-width: 300px;
    }
    
    .gesture-info {
      margin: 5px 0;
    }
    
    .gesture-info strong {
      color: #00ff00;
    }
      /* é€€å‡ºæŒ‰é’®æ ·å¼ */
    #exit-btn {
    position: absolute;      /* âœ… ç”¨ absoluteï¼Œç›¸å¯¹äº #video-container */
    top: 8px;
    right: 8px;              /* âœ… å³ä¸Šè§’ */
    z-index: 1101;           /* æ¯”è§†é¢‘å’Œç”»å¸ƒç•¥é«˜ */
    padding: 6px 10px;
    background: rgba(0, 0, 0, 0.75);
    color: #fff;
    border-radius: 999px;
    text-decoration: none;
    font-size: 12px;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    transition: background 0.2s ease, transform 0.1s ease;
    }

  </style>
</head>
<body>
  <!-- ç½‘ç«™ iframe -->
  <iframe id="website-frame" src="https://ppengnan.github.io/"></iframe>
  
  <!-- è™šæ‹Ÿå…‰æ ‡ -->
  <div id="cursor"></div>
  
  <!-- è§†é¢‘å®¹å™¨ -->
  <div id="video-container">
    <a href="/" id="exit-btn">â† Exit Gesture Mode</a>
    <video id="input_video" autoplay playsinline muted></video>
    <canvas id="output_canvas"></canvas>
  </div>
  
  <!-- ä¿¡æ¯é¢æ¿ -->
  <div id="info-panel">
    <div class="gesture-info"><strong>æ‰‹åŠ¿æ§åˆ¶:</strong></div>
    <div class="gesture-info">âœ‹ å¼ å¼€æ‰‹æŒ - ç§»åŠ¨å…‰æ ‡</div>
    <div class="gesture-info">ğŸ‘† é£ŸæŒ‡ç«–èµ· - æ»šåŠ¨é¡µé¢</div>
    <div class="gesture-info">ğŸ‘Œ æåˆæ‰‹åŠ¿ - ç‚¹å‡»</div>
    <div class="gesture-info" id="status">çŠ¶æ€: ç­‰å¾…æ£€æµ‹...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const cursor = document.getElementById('cursor');
    const statusElement = document.getElementById('status');
    
    // è°ƒæ•´ç”»å¸ƒå¤§å°
    function resizeCanvas() {
      const container = document.getElementById('video-container');
      canvasElement.width = container.clientWidth;
      canvasElement.height = container.clientHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    
    // æ‰‹åŠ¿çŠ¶æ€
    let lastGesture = null;
    let lastScrollY = 0;
    let clickCooldown = false;
    
    // è®¡ç®—ä¸¤ç‚¹è·ç¦»
    function getDistance(point1, point2) {
      return Math.sqrt(
        Math.pow(point1.x - point2.x, 2) + 
        Math.pow(point1.y - point2.y, 2)
      );
    }
    
    // è¯†åˆ«æ‰‹åŠ¿ç±»å‹
    function recognizeGesture(landmarks) {
      const thumbTip = landmarks[4];
      const indexTip = landmarks[8];
      const middleTip = landmarks[12];
      const ringTip = landmarks[16];
      const pinkyTip = landmarks[20];
      const indexBase = landmarks[5];
      const wrist = landmarks[0];
      
      // è®¡ç®—é£ŸæŒ‡æ˜¯å¦ä¼¸ç›´
      const indexStraight = indexTip.y < indexBase.y;
      const middleFolded = middleTip.y > landmarks[10].y;
      const ringFolded = ringTip.y > landmarks[14].y;
      const pinkyFolded = pinkyTip.y > landmarks[18].y;
      
      // æåˆæ‰‹åŠ¿ (æ‹‡æŒ‡å’Œé£ŸæŒ‡è·ç¦»å¾ˆè¿‘)
      const pinchDistance = getDistance(thumbTip, indexTip);
      if (pinchDistance < 0.05) {
        return { type: 'pinch', position: indexTip };
      }
      
      // é£ŸæŒ‡ç«–èµ· (æ»šåŠ¨)
      if (indexStraight && middleFolded && ringFolded && pinkyFolded) {
        return { type: 'scroll', position: indexTip };
      }
      
      // å¼ å¼€æ‰‹æŒ (ç§»åŠ¨å…‰æ ‡)
      const allExtended = 
        indexTip.y < indexBase.y &&
        middleTip.y < landmarks[10].y &&
        ringTip.y < landmarks[14].y &&
        pinkyTip.y < landmarks[18].y;
      
      if (allExtended) {
        return { type: 'move', position: indexTip };
      }
      
      return { type: 'none', position: indexTip };
    }
    
    // æ‰§è¡Œæ‰‹åŠ¿åŠ¨ä½œ
    function performGesture(gesture) {
      const x = gesture.position.x * window.innerWidth;
      const y = gesture.position.y * window.innerHeight;
      
      // æ›´æ–°å…‰æ ‡ä½ç½®
      cursor.style.left = x + 'px';
      cursor.style.top = y + 'px';
      cursor.style.display = 'block';
      
      switch(gesture.type) {
        case 'move':
          statusElement.textContent = 'çŠ¶æ€: ç§»åŠ¨å…‰æ ‡';
          cursor.className = '';
          break;
          
        case 'scroll':
          statusElement.textContent = 'çŠ¶æ€: æ»šåŠ¨é¡µé¢';
          const scrollDelta = (y - lastScrollY) * 2;
          window.scrollBy(0, scrollDelta);
          lastScrollY = y;
          break;
          
        case 'pinch':
          statusElement.textContent = 'çŠ¶æ€: ç‚¹å‡»';
          cursor.className = 'clicking';
          if (!clickCooldown) {
            // æ¨¡æ‹Ÿç‚¹å‡»
            const clickEvent = new MouseEvent('click', {
              bubbles: true,
              cancelable: true,
              view: window,
              clientX: x,
              clientY: y
            });
            document.elementFromPoint(x, y)?.dispatchEvent(clickEvent);
            
            clickCooldown = true;
            setTimeout(() => clickCooldown = false, 500);
          }
          break;
          
        default:
          statusElement.textContent = 'çŠ¶æ€: ç­‰å¾…æ‰‹åŠ¿';
          cursor.style.display = 'none';
      }
    }
    
    // åˆå§‹åŒ– MediaPipe Hands
    const hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });
    
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.5
    });
    
    hands.onResults(results => {
      // ç»˜åˆ¶è§†é¢‘å’Œæ‰‹éƒ¨è¿½è¸ª
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
      
      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        
        // ç»˜åˆ¶æ‰‹éƒ¨
        drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {
          color: '#00FF00', 
          lineWidth: 2
        });
        drawLandmarks(canvasCtx, landmarks, {
          color: '#FF0000', 
          lineWidth: 1,
          radius: 3
        });
        
        // è¯†åˆ«å¹¶æ‰§è¡Œæ‰‹åŠ¿
        const gesture = recognizeGesture(landmarks);
        performGesture(gesture);
      } else {
        cursor.style.display = 'none';
        statusElement.textContent = 'çŠ¶æ€: æœªæ£€æµ‹åˆ°æ‰‹';
      }
      
      canvasCtx.restore();
    });
    
    // å¯åŠ¨æ‘„åƒå¤´
    const camera = new Camera(videoElement, {
      onFrame: async () => await hands.send({image: videoElement}),
      width: 640,
      height: 480
    });
    camera.start();
  </script>
</body>
</html>
