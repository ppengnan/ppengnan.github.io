<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ‘‹ Gesture Control Mode (Pinch Drag Scroll)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      margin: 0; 
      overflow: hidden; 
      font-family: Arial, sans-serif;
    }
    
    #video-container {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 320px;
      height: 240px;
      border: 3px solid #00ff00;
      border-radius: 10px;
      overflow: hidden;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    #input_video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transform: scaleX(-1);       /* â— è§†é¢‘ç¿»è½¬ */
    }
    
    #output_canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transform: scaleX(-1);       /* â— è®©éª¨æ¶åŒ¹é…è§†é¢‘ */
    }

    
    #website-frame {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    
    #cursor {
      position: fixed;
      width: 40px;
      height: 40px;
      background-image: url('./arrow.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
      z-index: 999;
      display: none;
      transition: transform 0.1s;
      transform-origin: top left;
    }

    #cursor.clicking {
      transform: scale(1.3);
    }
    
    #info-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      z-index: 1000;
      font-size: 14px;
      max-width: 300px;
    }
    
    .gesture-info {
      margin: 5px 0;
    }
    
    .gesture-info strong {
      color: #00ff00;
    }
      /* é€€å‡ºæŒ‰é’®æ ·å¼ */
    #exit-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 1101;
      padding: 6px 10px;
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      border-radius: 999px;
      text-decoration: none;
      font-size: 12px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: background 0.2s ease, transform 0.1s ease;
    }


  </style>
</head>
<body>
  <!-- ç½‘ç«™ iframe -->
  <iframe id="website-frame" src="https://ppengnan.github.io/"></iframe>
  
  <!-- è™šæ‹Ÿå…‰æ ‡ -->
  <div id="cursor"></div>
  
  <!-- è§†é¢‘å®¹å™¨ -->
  <div id="video-container">
    <a href="/" id="exit-btn">â† Exit Gesture Mode</a>
    <video id="input_video" autoplay playsinline muted></video>
    <canvas id="output_canvas"></canvas>
  </div>

  
  <!-- ä¿¡æ¯é¢æ¿ -->
  <div id="info-panel">
    <div class="gesture-info"><strong>Gesture Control:</strong></div>
    <div class="gesture-info">âœ‹ Spread your palm - Move the cursor</div>
    <div class="gesture-info">ğŸ¤ Pinch + drag â€“ Scroll the page (like Vision Pro)</div>
    <div class="gesture-info">ğŸ¤ Short pinch (quick) â€“ Click</div>
    <div class="gesture-info" id="status">Status: Waiting for detectionâ€¦</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const cursor = document.getElementById('cursor');
    const statusElement = document.getElementById('status');
    
    function resizeCanvas() {
      const container = document.getElementById('video-container');
      canvasElement.width = container.clientWidth;
      canvasElement.height = container.clientHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    
    // ---------- å…¨å±€çŠ¶æ€ï¼ˆä¸»è¦æ”¹åŠ¨ï¼šä¸ºå·¦å³æ‰‹åˆ†åˆ«è·Ÿè¸ªæåˆçŠ¶æ€ï¼‰ ----------
    let clickCooldown = false;

    // ç”¨äº per-handedness è·Ÿè¸ªæåˆæ‹–åŠ¨ï¼ˆLeft / Rightï¼‰
    const pinchState = {
      Left:  { isPinching: false, frameCount: 0, lastY: null, startY: null, startTime: null, moved: false },
      Right: { isPinching: false, frameCount: 0, lastY: null, startY: null, startTime: null, moved: false }
    };

    // å‚æ•°ï¼šé˜ˆå€¼å’Œæ—¶é—´
    const PINCH_FRAMES_REQUIRED = 3;      // è¿ç»­å¸§æ•°ç¡®å®šå¼€å§‹æåˆ
    const PINCH_DISTANCE_THRESHOLD = 0.035; // æåˆè·ç¦»é˜ˆå€¼ï¼ˆå¯è°ƒï¼‰
    const SCROLL_SPEED = 22;              // æ»šåŠ¨é€Ÿåº¦ç³»æ•°ï¼ˆå¯è°ƒï¼‰
    const CLICK_MAX_DURATION = 300;       // msï¼ŒçŸ­ä¿ƒæåˆè§†ä¸ºç‚¹å‡»
    const CLICK_MAX_MOVE = 8;             // pxï¼ŒçŸ­ä¿ƒæåˆå…è®¸çš„æœ€å¤§ç§»åŠ¨é‡

    function getDistance(point1, point2) {
      return Math.sqrt(
        Math.pow(point1.x - point2.x, 2) + 
        Math.pow(point1.y - point2.y, 2)
      );
    }

    // recognizeGesture ç°åœ¨åªè´Ÿè´£è¿”å›å…³é”®ç‚¹ï¼ˆæ‹‡æŒ‡ã€é£ŸæŒ‡ã€æ‰‹æŒ‡ä¼¸ç›´ç­‰ï¼‰ï¼Œå®é™…åŠ¨ä½œç”± performGesture å¤„ç†
    function recognizeGesture(landmarks) {
      const thumbTip  = landmarks[4];
      const indexTip  = landmarks[8];
      const indexBase = landmarks[5];
      const middleTip = landmarks[12];
      const ringTip   = landmarks[16];
      const pinkyTip  = landmarks[20];
      const middleBase = landmarks[9];
      const ringBase   = landmarks[13];
      const pinkyBase  = landmarks[17];

      const pinchDistance = getDistance(thumbTip, indexTip);
      // é£ŸæŒ‡ä¼¸ç›´åˆ¤å®šï¼ˆç”¨äºç§»åŠ¨å…‰æ ‡ï¼‰
      const indexStraight = (indexBase.y - indexTip.y) > 0.05;
      const allExtended = indexStraight && (middleTip.y < middleBase.y) && (ringTip.y < ringBase.y) && (pinkyTip.y < pinkyBase.y);
      return {
        pinchDistance,
        indexTip,
        indexStraight,
        allExtended
      };
    }

    // performGesture ä¿®æ”¹è¦ç‚¹ï¼š
    // - æåˆä¸”æŒç»­ï¼šå¼€å§‹â€œæåˆæ‹–æ‹½æ»šåŠ¨â€ï¼ˆæåˆå¼€å§‹è®°å½• startY / startTimeï¼‰
    // - æåˆè¿‡ç¨‹ä¸­ï¼šè®¡ç®— y delta -> æ»šåŠ¨ iframeï¼ˆæ”¯æŒå·¦å³æ‰‹ç‹¬ç«‹ï¼‰
    // - æåˆç»“æŸï¼šè‹¥æŒç»­æ—¶é—´çŸ­ä¸”ç§»åŠ¨å° -> è§¦å‘ç‚¹å‡»ï¼›å¦åˆ™ç»“æŸæ»šåŠ¨ï¼Œä¸è§¦å‘ç‚¹å‡»
    function performGestureForHand(handedness, gestureData) {
      // handedness: "Left" / "Right"
      const state = pinchState[handedness];
      const indexTip = gestureData.indexTip;
      const pinchDistance = gestureData.pinchDistance;
      const allExtended = gestureData.allExtended;
      const indexStraight = gestureData.indexStraight;

      // å±å¹•åæ ‡
      const x = (1 - indexTip.x) * window.innerWidth;
      const y = indexTip.y * window.innerHeight;

      // æ˜¾ç¤ºå…‰æ ‡åœ¨æ‰‹æŒ‡å¤„ï¼ˆåˆå¹¶ä¸¤æ‰‹æ—¶ä¼šè¦†ç›–ï¼Œä½†è¿™æ˜¯å¯ä»¥æ¥å—çš„ï¼‰
      cursor.style.left = x + 'px';
      cursor.style.top = y + 'px';
      cursor.style.display = 'block';

      // æåˆåˆ¤å®šï¼ˆè¿ç»­å¸§ï¼‰
      if (pinchDistance < PINCH_DISTANCE_THRESHOLD) {
        state.frameCount++;
      } else {
        state.frameCount = 0;
      }

      // å¦‚æœè¿ç»­æ»¡è¶³ï¼Œè®¤ä¸ºè¿›å…¥â€œæåˆè¿›è¡Œä¸­â€
      if (!state.isPinching && state.frameCount >= PINCH_FRAMES_REQUIRED) {
        // æåˆå¼€å§‹
        state.isPinching = true;
        state.startY = y;
        state.lastY = y;
        state.startTime = performance.now();
        state.moved = false;
        // çŠ¶æ€æç¤º
        statusElement.textContent = `Status: ${handedness} hand pinching - start drag`;
      }

      // å¦‚æœå½“å‰å¤„äºæåˆä¸­ï¼ˆæŒç»­ï¼‰
      if (state.isPinching) {
        const rawDelta = y - state.lastY; // å‘ä¸‹ä¸ºæ­£
        // æŠ—æŠ–ï¼šåªåœ¨æ˜æ˜¾ç§»åŠ¨æ—¶æ»šåŠ¨
        if (Math.abs(rawDelta) >= 2) {
          // å¯¹ iframe è¿›è¡Œæ»šåŠ¨ï¼šå·¦å³æ‰‹å¯çº¦å®šä¸åŒæ–¹å‘æˆ–éƒ½å…è®¸ä»»æ„æ–¹å‘æ»šåŠ¨ï¼ˆè¿™é‡Œå…è®¸ä»»æ„æ–¹å‘ï¼‰
          const frame = document.getElementById('website-frame');
          if (frame && frame.contentWindow) {
            const scrollDelta = rawDelta * SCROLL_SPEED;
            try {
              frame.contentWindow.scrollBy(0, scrollDelta);
            } catch (e) {
              // å¯èƒ½è·¨åŸŸï¼Œä¸èƒ½è®¿é—® iframe å†…å®¹
              // ä½œä¸ºé™çº§æªæ–½ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒ window.scrollByï¼ˆæ»šåŠ¨å½“å‰é¡µé¢ï¼‰
              window.scrollBy(0, scrollDelta);
            }
          } else {
            window.scrollBy(0, rawDelta * SCROLL_SPEED);
          }
          state.moved = state.moved || Math.abs(y - state.startY) > CLICK_MAX_MOVE;
        }
        state.lastY = y;
      }

      // å¦‚æœæ²¡æœ‰æåˆï¼ˆä¹Ÿå¯èƒ½æ˜¯å¼ å¼€æ‰‹ palm moveï¼‰ï¼Œæ˜¾ç¤ºç§»åŠ¨å…‰æ ‡æˆ–æ»šåŠ¨æç¤º
      if (!state.isPinching) {
        if (allExtended) {
          statusElement.textContent = 'Status: Move the cursor (palm)';
          cursor.className = '';
        } else if (indexStraight) {
          statusElement.textContent = 'Status: Index up (no scroll - now use pinch drag)';
        } else {
          statusElement.textContent = 'Status: Waiting for gestureâ€¦';
          // è‹¥æ²¡æœ‰ä»»ä½•æ‰‹åŠ¿ï¼Œå…‰æ ‡ä¹Ÿå¯éšè—ï¼ˆå¯æ ¹æ®åå¥½è°ƒæ•´ï¼‰
          // cursor.style.display = 'none';
        }
      }
    }

    // å¤„ç†æåˆç»“æŸï¼ˆé’ˆå¯¹æŸä¸ª handï¼‰
    function handlePinchEnd(handedness) {
      const state = pinchState[handedness];
      if (!state.isPinching) return;
      const duration = performance.now() - state.startTime;
      const totalMove = Math.abs(state.lastY - state.startY || 0);

      // çŸ­ä¿ƒä¸”ç§»åŠ¨å° -> ç‚¹å‡»
      if (duration < CLICK_MAX_DURATION && totalMove <= CLICK_MAX_MOVE) {
        // è§¦å‘ç‚¹å‡»ï¼ˆåŒåŸæ¥é€»è¾‘ï¼‰
        triggerClickAtCursor();
        statusElement.textContent = `Status: ${handedness} click`;
      } else {
        statusElement.textContent = `Status: ${handedness} pinch ended`;
      }

      // é‡ç½®çŠ¶æ€
      state.isPinching = false;
      state.frameCount = 0;
      state.lastY = null;
      state.startY = null;
      state.startTime = null;
      state.moved = false;
    }

    // ç‚¹å‡»é€»è¾‘ï¼ˆä¸åŸæ¥ç±»ä¼¼ï¼‰
    function triggerClickAtCursor() {
      if (clickCooldown) return;
      const frame = document.getElementById('website-frame');
      const frameRect = frame.getBoundingClientRect();
      const cx = parseFloat(cursor.style.left || 0);
      const cy = parseFloat(cursor.style.top || 0);
      const iframeX = cx - frameRect.left;
      const iframeY = cy - frameRect.top;

      if (frame && frame.contentWindow) {
        try {
          const iframeDoc = frame.contentWindow.document;
          const targetElement = iframeDoc.elementFromPoint(iframeX, iframeY);
          
          if (targetElement) {
            const clickEvent = new MouseEvent('click', {
              bubbles: true,
              cancelable: true,
              view: frame.contentWindow,
              clientX: iframeX,
              clientY: iframeY
            });
            targetElement.dispatchEvent(clickEvent);
          }
        } catch (e) {
          console.warn('Cross-origin restrictions prevent access to iframe content:', e);
        }
      }

      cursor.className = 'clicking';
      clickCooldown = true;
      setTimeout(() => {
        clickCooldown = false;
        cursor.className = '';
      }, 400);
    }

    // ---------- åˆå§‹åŒ– MediaPipe Hands ----------
    const hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });
    
    // å…è®¸æ£€æµ‹å·¦å³æ‰‹ï¼ˆmaxNumHands: 2ï¼‰
    hands.setOptions({
      maxNumHands: 2,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.5
    });
    
    hands.onResults(results => {
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
      
      // å…ˆæŠŠæ‰€æœ‰æ‰‹éƒ½ç»˜åˆ¶å‡ºæ¥ï¼ˆå¦‚æœæœ‰ï¼‰
      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        for (let i = 0; i < results.multiHandLandmarks.length; i++) {
          const landmarks = results.multiHandLandmarks[i];
          drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {
            color: '#0000FF', 
            lineWidth: 1
          });
          drawLandmarks(canvasCtx, landmarks, {
            color: '#FF0000', 
            lineWidth: 1,
            radius: 1.5
          });
        }

        // å¯¹æ¯åªæ‰‹åˆ†åˆ«è¯†åˆ«å¹¶æ‰§è¡Œï¼šä½¿ç”¨ results.multiHandedness å¯¹åº”æ ‡ç­¾
        for (let i = 0; i < results.multiHandLandmarks.length; i++) {
          const landmarks = results.multiHandLandmarks[i];
          const rawHandedness = (results.multiHandedness && results.multiHandedness[i] && results.multiHandedness[i].label) || 'Right';
          // å› ä¸ºè§†é¢‘é•œåƒç¿»è½¬ï¼Œéœ€è¦åè½¬å·¦å³æ‰‹æ ‡ç­¾
          const handedness = rawHandedness === 'Left' ? 'Right' : 'Left';
          const g = recognizeGesture(landmarks);
          performGestureForHand(handedness, g);
        }
      } else {
        // å½“æ²¡æœ‰æ‰‹æ—¶ï¼šå¦‚æœä¹‹å‰ä»å¤„äºæåˆçŠ¶æ€ï¼ˆå¯èƒ½çªç„¶ä¸¢å¤±ï¼‰ï¼Œéœ€è¦æ”¶å°¾ï¼ˆæŠŠä¸¤åªæ‰‹çš„æåˆéƒ½ç»“æŸï¼‰
        handlePinchEnd('Left');
        handlePinchEnd('Right');
        cursor.style.display = 'none';
        statusElement.textContent = 'Status: Waiting for detectionâ€¦';
      }
      
      canvasCtx.restore();
    });
    
    // å¯åŠ¨æ‘„åƒå¤´
    const camera = new Camera(videoElement, {
      onFrame: async () => await hands.send({image: videoElement}),
      width: 640,
      height: 480
    });
    camera.start();

    // ç›‘å¬ä¸€ä¸ªå°å®šæ—¶å™¨æ¥æ¢æµ‹â€œæåˆç»“æŸâ€çš„è¾¹ç•Œæƒ…å†µï¼š
    // å¦‚æœæŸä¸€å¸§æ»¡è¶³æåˆå¼€å§‹ï¼ˆisPinchingï¼‰ä½†ä¸‹ä¸€å¸§åˆæ²¡æœ‰ï¼Œåˆ™ handlePinchEnd åº”è¯¥è¢«è°ƒç”¨ã€‚
    // æˆ‘ä»¬é€šè¿‡å®šæ—¶å™¨å®šæœŸæ£€æŸ¥ frameCountï¼ˆè‹¥ frameCount==0 ä¸”æ­¤å‰ isPinchingï¼‰åˆ™ç»“æŸã€‚
    setInterval(() => {
      ['Left','Right'].forEach(h => {
        const s = pinchState[h];
        if (s.isPinching && s.frameCount === 0) {
          // æåˆåˆšåˆšç»“æŸ
          handlePinchEnd(h);
        }
      });
    }, 80); // æ¯ 80ms æ£€æŸ¥ä¸€æ¬¡ï¼ˆå¯è°ƒï¼‰

  </script>
</body>
</html>
