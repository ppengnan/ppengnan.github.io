<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ‘‹ Gesture Control Mode</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      margin: 0; 
      overflow: hidden; 
      font-family: Arial, sans-serif;
    }
    
    #video-container {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 320px;
      height: 240px;
      border: 3px solid #00ff00;
      border-radius: 10px;
      overflow: hidden;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    #input_video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transform: scaleX(-1);       /* â— è§†é¢‘ç¿»è½¬ */
    }
    
    #output_canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transform: scaleX(-1);       /* â— è®©éª¨æ¶åŒ¹é…è§†é¢‘ */
    }

    
    #website-frame {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    
    #cursor {
      position: fixed;
      width: 40px;              /* å¯ä»¥æ ¹æ®å›¾ç‰‡å¤§å°è°ƒæ•´ */
      height: 40px;
      background-image: url('./arrow.png');  /* âœ… è¿™é‡Œå†™ä½ çš„å›¾ç‰‡æ–‡ä»¶å */
      background-size: contain;  /* ç­‰æ¯”ç¼©æ”¾ï¼Œå®Œæ•´æ˜¾ç¤ºç®­å¤´ */
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;      /* ä¸æŒ¡ä½ç‚¹å‡»äº‹ä»¶ */
      z-index: 999;
      display: none;
      transition: transform 0.1s;
      transform-origin: top left;  /* è®©ç¼©æ”¾ä»¥ç®­å¤´å·¦ä¸Šè§’ä¸ºåŸºå‡†ï¼Œæ¯”è¾ƒåƒç³»ç»Ÿé¼ æ ‡ */
    }

    /* ç‚¹å‡»æ—¶è®©ç®­å¤´ç¨å¾®å˜å¤§ä¸€ç‚¹ */
    #cursor.clicking {
      transform: scale(1.3);
    }
    
    #info-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      z-index: 1000;
      font-size: 14px;
      max-width: 300px;
    }
    
    .gesture-info {
      margin: 5px 0;
    }
    
    .gesture-info strong {
      color: #00ff00;
    }
      /* é€€å‡ºæŒ‰é’®æ ·å¼ */
    #exit-btn {
    position: absolute;      /* âœ… ç”¨ absoluteï¼Œç›¸å¯¹äº #video-container */
    top: 8px;
    right: 8px;              /* âœ… å³ä¸Šè§’ */
    z-index: 1101;           /* æ¯”è§†é¢‘å’Œç”»å¸ƒç•¥é«˜ */
    padding: 6px 10px;
    background: rgba(0, 0, 0, 0.75);
    color: #fff;
    border-radius: 999px;
    text-decoration: none;
    font-size: 12px;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    transition: background 0.2s ease, transform 0.1s ease;
    }

  </style>
</head>
<body>
  <!-- ç½‘ç«™ iframe -->
  <iframe id="website-frame" src="https://ppengnan.github.io/"></iframe>
  
  <!-- è™šæ‹Ÿå…‰æ ‡ -->
  <div id="cursor"></div>
  
  <!-- è§†é¢‘å®¹å™¨ -->
  <div id="video-container">
    <a href="/" id="exit-btn">â† Exit Gesture Mode</a>
    <video id="input_video" autoplay playsinline muted></video>
    <canvas id="output_canvas"></canvas>
  </div>
  
  <!-- ä¿¡æ¯é¢æ¿ -->
  <div id="info-panel">
    <div class="gesture-info"><strong>Gesture Control:</strong></div>
    <div class="gesture-info">âœ‹ Spread your palm - Move the cursor</div>
    <div class="gesture-info">ğŸ‘† Index finger raised â€“ scroll the page</div>
    <div class="gesture-info">ğŸ‘Œ Pinch gesture â€“ click</div>
    <div class="gesture-info" id="status">Status: Waiting for detectionâ€¦</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const cursor = document.getElementById('cursor');
    const statusElement = document.getElementById('status');
    
    // è°ƒæ•´ç”»å¸ƒå¤§å°
    function resizeCanvas() {
      const container = document.getElementById('video-container');
      canvasElement.width = container.clientWidth;
      canvasElement.height = container.clientHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    
    // æ‰‹åŠ¿çŠ¶æ€
    let lastGesture = null;
    let lastScrollY = 0;
    let clickCooldown = false;
    
    // è®¡ç®—ä¸¤ç‚¹è·ç¦»
    function getDistance(point1, point2) {
      return Math.sqrt(
        Math.pow(point1.x - point2.x, 2) + 
        Math.pow(point1.y - point2.y, 2)
      );
    }
    
    // è¯†åˆ«æ‰‹åŠ¿ç±»å‹ï¼ˆæ›´ç¨³å®šç‰ˆï¼‰
    function recognizeGesture(landmarks) {
      const thumbTip  = landmarks[4];
      const indexTip  = landmarks[8];
      const middleTip = landmarks[12];
      const ringTip   = landmarks[16];
      const pinkyTip  = landmarks[20];

      const indexBase  = landmarks[5];
      const middleBase = landmarks[9];
      const ringBase   = landmarks[13];
      const pinkyBase  = landmarks[17];

      // 1) å…ˆç®—æ‹‡æŒ‡-é£ŸæŒ‡è·ç¦»ï¼ˆæåˆï¼‰
      const pinchDistance = getDistance(thumbTip, indexTip);

      // 2) åˆ¤æ–­æ¯æ ¹æ‰‹æŒ‡æ˜¯ä¸æ˜¯â€œä¼¸ç›´â€
      // y è¶Šå° = è¶Šé ä¸Šï¼Œæ‰€ä»¥ tip.y < base.y ä»£è¡¨ä¼¸ç›´
      const indexStraight  = indexTip.y  < indexBase.y;
      const middleStraight = middleTip.y < middleBase.y;
      const ringStraight   = ringTip.y   < ringBase.y;
      const pinkyStraight  = pinkyTip.y  < pinkyBase.y;

      const allExtended =
        indexStraight && middleStraight && ringStraight && pinkyStraight;

      // 3) æ‰‹åŠ¿ä¼˜å…ˆçº§ï¼š
      //    æåˆ > å¼ å¼€æ‰‹æŒ > é£ŸæŒ‡ç«–èµ·æ»šåŠ¨

      // â‘  æåˆ = ç‚¹å‡»
      if (pinchDistance < 0.06) {   // ç¨å¾®æ”¾å®½ä¸€ç‚¹é˜ˆå€¼
        return { type: 'pinch', position: indexTip };
      }

      // â‘¡ å››æŒ‡éƒ½ä¼¸ç›´ = ç§»åŠ¨å…‰æ ‡ï¼ˆå¼ å¼€æ‰‹æŒï¼‰
      if (allExtended) {
        return { type: 'move', position: indexTip };
      }

      // â‘¢ åªæœ‰é£ŸæŒ‡æ˜æ˜¾ä¼¸ç›´ = æ»šåŠ¨
      if (indexStraight) {
        return { type: 'scroll', position: indexTip };
      }

      // â‘£ å…¶ä»–æƒ…å†µ = æ— æ‰‹åŠ¿
      return { type: 'none', position: indexTip };
    }

    // æ‰§è¡Œæ‰‹åŠ¿åŠ¨ä½œï¼ˆåŠ å…¥æ»šåŠ¨å¹³æ»‘ & æŠ—æŠ–åŠ¨ï¼‰
    function performGesture(gesture) {
      const x = (1 - gesture.position.x) * window.innerWidth;
      const y = gesture.position.y * window.innerHeight;

      // å¦‚æœå½“å‰æ˜¯æ»šåŠ¨æ‰‹åŠ¿å¹¶ä¸”åˆšåˆšä»åˆ«çš„æ‰‹åŠ¿åˆ‡æ¢è¿‡æ¥ï¼Œ
      // å…ˆé‡ç½®åŸºå‡†ç‚¹ï¼Œé¿å…ä¸€ä¸Šæ¥å°±çŒ›å†²
      if (gesture.type === 'scroll' && lastGesture !== 'scroll') {
        lastScrollY = y;
      }
      // è®°ä½ä¸Šä¸€å¸§çš„æ‰‹åŠ¿ç±»å‹
      lastGesture = gesture.type;

      // æ›´æ–°å…‰æ ‡ä½ç½®
      cursor.style.left = x + 'px';
      cursor.style.top = y + 'px';
      cursor.style.display = 'block';

      switch (gesture.type) {
        case 'move':
          statusElement.textContent = 'çŠ¶æ€: ç§»åŠ¨å…‰æ ‡';
          cursor.className = '';
          break;

        case 'scroll': {
          statusElement.textContent = 'çŠ¶æ€: æ»šåŠ¨é¡µé¢';

          // è®¡ç®—æœ¬æ¬¡æ‰‹æŒ‡ç§»åŠ¨é‡
          const rawDelta = y - lastScrollY;

          // ğŸ”¹ æŠ—æŠ–åŠ¨ï¼šå¦‚æœç§»åŠ¨å¤ªå°ï¼Œå°±å½“ä½œæ²¡åŠ¨ï¼ˆä¸ä¸Šä¸‹æŠ–ï¼‰
          if (Math.abs(rawDelta) < 3) {
            break;
          }

          // ğŸ”¹ è°ƒæ•´æ»šåŠ¨é€Ÿåº¦ï¼ˆè¶Šå°è¶Šæ…¢ï¼‰
          const SCROLL_SPEED = 20; // é€Ÿåº¦å¤§å°

          // å³æ‰‹ï¼šæ­£å¸¸æ–¹å‘ï¼›å·¦æ‰‹ï¼šåå‘æ»šåŠ¨
          const direction = gesture.handedness === 'Left' ? -1 : 1;
          
          const scrollDelta = rawDelta * SCROLL_SPEED * direction;

          // æ›´æ–°åŸºå‡†ç‚¹
          lastScrollY = y;

          // æ»šåŠ¨ iframe é‡Œçš„é¡µé¢
          const frame = document.getElementById('website-frame');
          if (frame && frame.contentWindow) {
            frame.contentWindow.scrollBy(0, scrollDelta);
          }
          break;
        }

        case 'pinch':
          statusElement.textContent = 'çŠ¶æ€: ç‚¹å‡»';
          cursor.className = 'clicking';
          if (!clickCooldown) {
            // âœ… è·å– iframe å’Œå…¶è¾¹ç•Œ
            const frame = document.getElementById('website-frame');
            const frameRect = frame.getBoundingClientRect();
            
            // âœ… è®¡ç®—ç›¸å¯¹äº iframe å†…éƒ¨çš„åæ ‡
            const iframeX = x - frameRect.left;
            const iframeY = y - frameRect.top;
            
            // âœ… åœ¨ iframe å†…éƒ¨è§¦å‘ç‚¹å‡»
            if (frame && frame.contentWindow) {
              try {
                const iframeDoc = frame.contentWindow.document;
                const targetElement = iframeDoc.elementFromPoint(iframeX, iframeY);
                
                if (targetElement) {
                  const clickEvent = new MouseEvent('click', {
                    bubbles: true,
                    cancelable: true,
                    view: frame.contentWindow,
                    clientX: iframeX,
                    clientY: iframeY
                  });
                  targetElement.dispatchEvent(clickEvent);
                }
              } catch (e) {
                console.warn('è·¨åŸŸé™åˆ¶,æ— æ³•è®¿é—® iframe å†…å®¹:', e);
              }
            }
        
            clickCooldown = true;
            setTimeout(() => (clickCooldown = false), 500);
          }
          break;

        default:
          statusElement.textContent = 'çŠ¶æ€: ç­‰å¾…æ‰‹åŠ¿';
          cursor.style.display = 'none';
      }
    }

    
    // åˆå§‹åŒ– MediaPipe Hands
    const hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });
    
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.5
    });
    
    hands.onResults(results => {
      // ç»˜åˆ¶è§†é¢‘å’Œæ‰‹éƒ¨è¿½è¸ª
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
      
      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        
        // ç»˜åˆ¶æ‰‹éƒ¨
        drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {
          color: '#0000FF', 
          lineWidth: 1
        });
        drawLandmarks(canvasCtx, landmarks, {
          color: '#FF0000', 
          lineWidth: 1,
          radius: 2
        });
        
        // è¯†åˆ«å¹¶æ‰§è¡Œæ‰‹åŠ¿
        // è¯†åˆ«å·¦å³æ‰‹ï¼ˆLeft / Rightï¼‰
        const handedness = results.multiHandedness?.[0]?.label || 'Right';
        
        // è¯†åˆ«å¹¶æ‰§è¡Œæ‰‹åŠ¿
        const gesture = recognizeGesture(landmarks);
        // æŠŠå·¦å³æ‰‹ä¿¡æ¯æŒ‚åœ¨ gesture ä¸Š
        gesture.handedness = handedness;
        
        performGesture(gesture);
      } else {
        cursor.style.display = 'none';
        statusElement.textContent = 'Status: Waiting for detectionâ€¦';
      }
      
      canvasCtx.restore();
    });
    
    // å¯åŠ¨æ‘„åƒå¤´
    const camera = new Camera(videoElement, {
      onFrame: async () => await hands.send({image: videoElement}),
      width: 640,
      height: 480
    });
    camera.start();
  </script>
</body>
</html>
